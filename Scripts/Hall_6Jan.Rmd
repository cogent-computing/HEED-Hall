---
title: "Hall data analysis"
output: 
  pdf_document: default
    fig_caption: yes
---

This is a report based on analysis of Hall data for the months of Aug-Oct 2019.
We first concatenate all files for a month and then for the 3 months for each CPE and sockets.

```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(readxl)
library(tidyverse)
library(stringr)
library(rlang)
library(readr)

#We start by analysing CPE files (CPE1-7) for Aug-Oct 2019 to extract instantaneous power - LED1_P, LED2_P, LED3_P

#For each CPE we concatenate files for each day of the month and then the 3 months
cpe1 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE1/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE1/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE1/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption variables only - mW
    df_sub <- df[df$variable=="LED1_P" | df$variable=="LED2_P" | df$variable=="LED3_P",]
    df_sub$value <- as.numeric(df_sub$value)/1000.0
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for each variable - led1_p, led2_p, led3_p
    df2 <- df_sub %>%
      group_by(variable, timeUse) %>%
      summarise(value = mean(value))
    
    #Add date from the file name
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    cpe1 <- rbind(cpe1, df)
  }
}
cpe1$id <- rep("CPE1", length(cpe1$value))

cpe2 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE2/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE2/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE2/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption variables only - mW
    df_sub <- df[df$variable=="LED1_P" | df$variable=="LED2_P" | df$variable=="LED3_P",]
    df_sub$value <- as.numeric(df_sub$value)/1000.0
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for each variable - led1_p, led2_p, led3_p
    df2 <- df_sub %>%
      group_by(variable, timeUse) %>%
      summarise(value = mean(value))
    
    #Add date from the file name
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    cpe2 <- rbind(cpe2, df)
  }
}
cpe2$id <- rep("CPE2", length(cpe2$value))

cpe3 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE3/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE3/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE3/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption variables only - mW
    df_sub <- df[df$variable=="LED1_P" | df$variable=="LED2_P" | df$variable=="LED3_P",]
    df_sub$value <- as.numeric(df_sub$value)/1000.0
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for each variable - led1_p, led2_p, led3_p
    df2 <- df_sub %>%
      group_by(variable, timeUse) %>%
      summarise(value = mean(value))
    
    #Add date from the file name
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    cpe3 <- rbind(cpe3, df)
  }
}
cpe3$id <- rep("CPE3", length(cpe3$value))

cpe4 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE4/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE4/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE4/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption variables only - mW
    df_sub <- df[df$variable=="LED1_P" | df$variable=="LED2_P" | df$variable=="LED3_P",]
    df_sub$value <- as.numeric(df_sub$value)/1000.0
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for each variable - led1_p, led2_p, led3_p
    df2 <- df_sub %>%
      group_by(variable, timeUse) %>%
      summarise(value = mean(value))
    
    #Add date from the file name
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    cpe4 <- rbind(cpe4, df)
  }
}
cpe4$id <- rep("CPE4", length(cpe4$value))

cpe5 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE5 (outdoor lights)/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE5 (outdoor lights)/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE5 (outdoor lights)/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption variables only - mW
    df_sub <- df[df$variable=="LED1_P" | df$variable=="LED2_P" | df$variable=="LED3_P",]
    df_sub$value <- as.numeric(df_sub$value)/1000.0
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for each variable - led1_p, led2_p, led3_p
    df2 <- df_sub %>%
      group_by(variable, timeUse) %>%
      summarise(value = mean(value))
    
    #Add date from the file name
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    cpe5 <- rbind(cpe5, df)
  }
}
cpe5$id <- rep("CPE5", length(cpe5$value))

cpe6 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE6/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE6/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE6/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption variables only - mW
    df_sub <- df[df$variable=="LED1_P" | df$variable=="LED2_P" | df$variable=="LED3_P",]
    df_sub$value <- as.numeric(df_sub$value)/1000.0
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for each variable - led1_p, led2_p, led3_p
    df2 <- df_sub %>%
      group_by(variable, timeUse) %>%
      summarise(value = mean(value))
    
    #Add date from the file name
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    cpe6 <- rbind(cpe6, df)
  }
}
cpe6$id <- rep("CPE6", length(cpe6$value))

cpe7 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE7/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE7/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall CPE7/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption variables only - mW
    df_sub <- df[df$variable=="LED1_P" | df$variable=="LED2_P" | df$variable=="LED3_P",]
    df_sub$value <- as.numeric(df_sub$value)/1000.0
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for each variable - led1_p, led2_p, led3_p
    df2 <- df_sub %>%
      group_by(variable, timeUse) %>%
      summarise(value = mean(value))
    
    #Add date from the file name
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    cpe7 <- rbind(cpe7, df)
  }
}
cpe7$id <- rep("CPE7", length(cpe7$value))

#Combining all CPEs
cpe_all <- data.frame()
cpe_all <- rbind(cpe_all, cpe1, cpe2, cpe3, cpe4, cpe5, cpe6, cpe7)
cpe_all <- cpe_all[order(cpe_all$date),]


#Analysing all sockets to retrieve instantaneous power (vRELAY1_LVL) and 
#daily cumulative energy total (AC_Day_Energy_session)
#We have a total of 4 sockets
s1 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S1/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S1/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S1/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption (vRELAY1_LVL in W) and cumulative energy (AC_Day_Energy_session in Wattmin)
    df_sub <- df[df$variable=="vRELAY1_LVL" | df$variable=="AC_Day_Energy_session", ]
    df_sub$value <- as.numeric(df_sub$value)
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for instantaneous power
    df2 <- df_sub[df_sub$variable=="vRELAY1_LVL",] %>%
      group_by(timeUse) %>%
      summarise(value = mean(value))
    df2$variable <-rep("vRELAY1_LVL", length(df2$timeUse))
    
    #Correct cumulative total energy if not reset
    df3_sub <- df_sub[df_sub$variable=="AC_Day_Energy_session", ]
    if(df3_sub$value[1]!=0) { #If value has not reset
      #find if and where the value has reset
      flag=FALSE
      for(l in 2:length(df3_sub$timestamp)) {
        if(flag==FALSE & df3_sub$value[l] < df3_sub$value[l-1]) {
          flag=TRUE
          index <- l
        }
      }
      if(flag==FALSE) { #Means the value never reset to 0
        #Subtract value at 0th index from all values
        df3_sub$value2 <- df3_sub$value - df3_sub$value[1]
      } else {
        df3_sub$value2 <- df3_sub$value
        df3_sub$value2[1:(index-1)] <- (df3_sub$value[1:(index-1)] - df3_sub$value[1])
        df3_sub$value2[index:length(df3_sub$timestamp)] <- 
          df3_sub$value[index:length(df3_sub$timestamp)] + df3_sub$value2[index-1]
      }
    } else {
      df3_sub$value2 <- df3_sub$value
    }
    
    #Extract cumulative total energy per hour
    df3 <- df3_sub %>%
      group_by(timeUse) %>%
      summarise(value = value2[length(value2)])
    df3$variable <-rep("AC_Day_Energy_session", length(df3$timeUse))
    
    #Bind the 2 data frames and add date from the file name
    df2 <- rbind(df2, df3)
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    s1 <- rbind(s1, df)
  }
}
s1$id <- rep("S1", length(s1$value))

s2 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S2/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S2/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S2/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption (vRELAY1_LVL in W) and cumulative energy (AC_Day_Energy_session in Wattmin)
    df_sub <- df[df$variable=="vRELAY1_LVL" | df$variable=="AC_Day_Energy_session", ]
    df_sub$value <- as.numeric(df_sub$value)
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for instantaneous power
    df2 <- df_sub[df_sub$variable=="vRELAY1_LVL",] %>%
      group_by(timeUse) %>%
      summarise(value = mean(value))
    df2$variable <-rep("vRELAY1_LVL", length(df2$timeUse))
    
    #Correct cumulative total energy if not reset
    df3_sub <- df_sub[df_sub$variable=="AC_Day_Energy_session", ]
    if(df3_sub$value[1]!=0) { #If value has not reset
      #find if and where the value has reset
      flag=FALSE
      for(l in 2:length(df3_sub$timestamp)) {
        if(flag==FALSE & df3_sub$value[l] < df3_sub$value[l-1]) {
          flag=TRUE
          index <- l
        }
      }
      if(flag==FALSE) { #Means the value never reset to 0
        #Subtract value at 0th index from all values
        df3_sub$value2 <- df3_sub$value - df3_sub$value[1]
      } else {
        df3_sub$value2 <- df3_sub$value
        df3_sub$value2[1:(index-1)] <- (df3_sub$value[1:(index-1)] - df3_sub$value[1])
        df3_sub$value2[index:length(df3_sub$timestamp)] <- 
          df3_sub$value[index:length(df3_sub$timestamp)] + df3_sub$value2[index-1]
      }
    } else {
      df3_sub$value2 <- df3_sub$value
    }
    
    #Extract cumulative total energy per hour
    df3 <- df3_sub %>%
      group_by(timeUse) %>%
      summarise(value = value2[length(value2)])
    df3$variable <-rep("AC_Day_Energy_session", length(df3$timeUse))
    
    #Bind the 2 data frames and add date from the file name
    df2 <- rbind(df2, df3)
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    s2 <- rbind(s2, df)
  }
}
s2$id <- rep("S2", length(s2$value))

s3 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S3/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S3/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S3/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption (vRELAY1_LVL in W) and cumulative energy (AC_Day_Energy_session in Wattmin)
    df_sub <- df[df$variable=="vRELAY1_LVL" | df$variable=="AC_Day_Energy_session", ]
    df_sub$value <- as.numeric(df_sub$value)
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for instantaneous power
    df2 <- df_sub[df_sub$variable=="vRELAY1_LVL",] %>%
      group_by(timeUse) %>%
      summarise(value = mean(value))
    df2$variable <-rep("vRELAY1_LVL", length(df2$timeUse))
    
    #Correct cumulative total energy if not reset
    df3_sub <- df_sub[df_sub$variable=="AC_Day_Energy_session", ]
    if(df3_sub$value[1]!=0) { #If value has not reset
      #find if and where the value has reset
      flag=FALSE
      for(l in 2:length(df3_sub$timestamp)) {
        if(flag==FALSE & df3_sub$value[l] < df3_sub$value[l-1]) {
          flag=TRUE
          index <- l
        }
      }
      if(flag==FALSE) { #Means the value never reset to 0
        #Subtract value at 0th index from all values
        df3_sub$value2 <- df3_sub$value - df3_sub$value[1]
      } else {
        df3_sub$value2 <- df3_sub$value
        df3_sub$value2[1:(index-1)] <- (df3_sub$value[1:(index-1)] - df3_sub$value[1])
        df3_sub$value2[index:length(df3_sub$timestamp)] <- 
          df3_sub$value[index:length(df3_sub$timestamp)] + df3_sub$value2[index-1]
      }
    } else {
      df3_sub$value2 <- df3_sub$value
    }
    
    #Extract cumulative total energy per hour
    df3 <- df3_sub %>%
      group_by(timeUse) %>%
      summarise(value = value2[length(value2)])
    df3$variable <-rep("AC_Day_Energy_session", length(df3$timeUse))
    
    #Bind the 2 data frames and add date from the file name
    df2 <- rbind(df2, df3)
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    s3 <- rbind(s3, df)
  }
}
s3$id <- rep("S3", length(s3$value))

s4 <- data.frame()
for(j in 1:3) {
  if(j==1) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S4/08 2019/")
  } else if(j==2) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S4/09 2019/")
  } else if(j==3) {
    setwd("~/OneDrive - Coventry University/HEED_analysis/Hall/Hall S4/10 2019/")
  }
  file_list <- list.files()
  for(i in 1:length(file_list)) {
    df <- read.csv(file_list[i], header = FALSE, quote = "\"", skipNul = TRUE)
    colnames(df) <- c("timestamp", "variable", "value")
    df$value <- as.character(df$value)
    df$variable <- as.character(df$variable)
    
    #Separate the power consumption (vRELAY1_LVL in W) and cumulative energy (AC_Day_Energy_session in Wattmin)
    df_sub <- df[df$variable=="vRELAY1_LVL" | df$variable=="AC_Day_Energy_session", ]
    df_sub$value <- as.numeric(df_sub$value)
    
    #Add time - we need to extract hours to get hourly means
    df_sub$time <- as.POSIXct(df_sub$timestamp, tz="GMT", origin="1970-01-01")
    df_sub$timeUse <- format(df_sub$time, format='%H')
    
    #Extract hourly means for instantaneous power
    df2 <- df_sub[df_sub$variable=="vRELAY1_LVL",] %>%
      group_by(timeUse) %>%
      summarise(value = mean(value))
    df2$variable <-rep("vRELAY1_LVL", length(df2$timeUse))
    
    #Correct cumulative total energy if not reset
    df3_sub <- df_sub[df_sub$variable=="AC_Day_Energy_session", ]
    if(df3_sub$value[1]!=0) { #If value has not reset
      #find if and where the value has reset
      flag=FALSE
      for(l in 2:length(df3_sub$timestamp)) {
        if(flag==FALSE & df3_sub$value[l] < df3_sub$value[l-1]) {
          flag=TRUE
          index <- l
        }
      }
      if(flag==FALSE) { #Means the value never reset to 0
        #Subtract value at 0th index from all values
        df3_sub$value2 <- df3_sub$value - df3_sub$value[1]
      } else {
        df3_sub$value2 <- df3_sub$value
        df3_sub$value2[1:(index-1)] <- (df3_sub$value[1:(index-1)] - df3_sub$value[1])
        df3_sub$value2[index:length(df3_sub$timestamp)] <- 
          df3_sub$value[index:length(df3_sub$timestamp)] + df3_sub$value2[index-1]
      }
    } else {
      df3_sub$value2 <- df3_sub$value
    }
    
    #Extract cumulative total energy per hour
    df3 <- df3_sub %>%
      group_by(timeUse) %>%
      summarise(value = value2[length(value2)])
    df3$variable <-rep("AC_Day_Energy_session", length(df3$timeUse))
    
    #Bind the 2 data frames and add date from the file name
    df2 <- rbind(df2, df3)
    df2$date <- as.Date((rep(gsub("\\..*","",file_list[i]), length(df2$value))),
                        format = "%d-%m-%Y")
    
    #Create a data frame with the above values and bind to a complete df 
    df <- data.frame(date=df2$date, hour=df2$timeUse, 
                     variable=df2$variable, value=df2$value)
    df$hour <- as.character(df$hour)
    df$variable <- as.character(df$variable)
    s4 <- rbind(s4, df)
  }
}
s4$id <- rep("S4", length(s4$value))

#Combining all 4 sockets
s_all <- data.frame()
s_all <- rbind(s_all, s1, s2, s3, s4)
s_all <- s_all[order(s_all$date),]
```

Next, we read in the system and weather data

```{r, echo=FALSE}
#Reading in System data - with 3 lines of column headers
#One file under full data from June to Nov - europe time zone
filename <- "~/OneDrive - Coventry University/HEED_analysis/Hall/System data/Full data/June to Nov/HEEDNyabihekeHall_log_20190531-2300_to_20191130-1033.csv"
headers <- read_csv(filename, col_names = FALSE, na="..", n_max = 3)
#Replace NA in header with "" for missing row 3 values
headers[is.na(headers)] <- ""
column_labels <- headers %>% summarize_all(str_c, collapse = " ")
headers = unname(unlist(column_labels[1,]))
system_data <- read_csv(filename, col_names = headers, na="..", skip = 3)
#Replace NA in data frame with "" for missing values as in raw file
system_data[is.na(system_data)] <- ""

#Extract system overview data for AC Consumption L1 - W
#Find all column names with System overview
columns <- headers[which(grepl("System overview", headers, fixed=TRUE))]
#Find all column names with AC Consumption L1
colNames <- columns[which(grepl("AC Consumption L1", columns, fixed=TRUE))]
colNames <- c(headers[1], colNames) 
sysOverview <- system_data[,colNames]

#Extract Solar Charger data to get PV power - W
#Find all column names with Solar Charger
columns <- headers[which(grepl("Solar Charger", headers, fixed=TRUE))]
#Find all column names with PV power
colNames <- columns[which(grepl("PV power", columns, fixed=TRUE))]
colNames <- c(headers[1], colNames) 
solarCharger <- system_data[,colNames]

#Extract Battery Monitor data to get State of charge (%), Discharged Energy(kWh), Charged Energy(kWh)
#Find all column names with Solar Charger
columns <- headers[which(grepl("Battery Monitor", headers, fixed=TRUE))]
#Find all column names with State of charge
colNames <- columns[which(grepl("State of charge", columns, fixed=TRUE))]
#Find all column names with Discharged Energy
colNames <- c(colNames, columns[which(grepl("Discharged Energy", columns, fixed=TRUE))])
#Find all column names with Charged Energy
colNames <- c(colNames, columns[which(grepl("Charged Energy", columns, fixed=TRUE))])
colNames <- c(headers[1], colNames) 
batteryMonitor <- system_data[,colNames]

systemData <- data.frame()
systemData <- cbind(sysOverview, solarCharger[,-1], batteryMonitor[,-1])
systemData$`System overview [0] AC Consumption L1 W` <- 
  as.numeric(systemData$`System overview [0] AC Consumption L1 W`)
systemData$`Solar Charger [260] PV power ` <- 
  as.numeric(systemData$`Solar Charger [260] PV power `)
systemData$`Battery Monitor [258] Discharged Energy kWh` <- 
  as.numeric(systemData$`Battery Monitor [258] Discharged Energy kWh`)
systemData$`Battery Monitor [258] Charged Energy kWh` <- 
  as.numeric(systemData$`Battery Monitor [258] Charged Energy kWh`) 
#Converting time in Rwandan time zone by adding an hour
systemData$`timestamp Europe/Berlin (+01:00) ` <- systemData$`timestamp Europe/Berlin (+01:00) ` +
  1*60*60

#Reading in weather data
filename <- "~/OneDrive - Coventry University/HEED_analysis/Hall/Weather data/weather_data.xlsx"
headers <- read_excel(filename, col_names = FALSE, na="..", n_max = 2)
#Replace NA in header with "" for missing row 3 values
headers[is.na(headers)] <- ""
column_labels <- headers %>% summarize_all(str_c, collapse = " ")
headers = unname(unlist(column_labels[1,]))
weather_data <- read_excel(filename, col_names = headers, na="..", skip = 2,
                           col_types=c("date","numeric","numeric"))
#Replace NA in data frame with "" for missing values as in raw file
weather_data[is.na(weather_data)] <- ""
#Data is 12 years behind - change year to 2019
year(weather_data$`Time (2019!) `) <- 2019
```

Next, we plot the graphs for RQ1 - How do refugees use energy and what are their energy needs, patterns of use and aspirations?

The following box plots are to be created on a monthly basis for the hall.
1. Hourly energy consumption (all lights + sockets) from the hall for a week/weekend day in (month).

```{r, echo=FALSE}
#Combine all power consumption data
pc <- data.frame()
pc <- rbind(pc, cpe_all, s_all[s_all$variable=="vRELAY1_LVL",])
#Adding energy consumption per hour per day
pc_sum <- pc %>%
  group_by(date, hour) %>%
  summarise(value=sum(value))

#Add days of week to separate weekends from weekdays
pc_sum$wday <- weekdays(as.Date(pc_sum$date), abbreviate = TRUE)
pc_sum$month <- as.character(month(pc_sum$date, label=TRUE, abbr=TRUE))
pc_sum_wday <- pc_sum[pc_sum$wday=="Mon" | pc_sum$wday=="Tue" | pc_sum$wday=="Wed" | 
                        pc_sum$wday=="Thu" | pc_sum$wday=="Fri", ]
pc_sum_weday <- pc_sum[pc_sum$wday=="Sat" | pc_sum$wday=="Sun" , ]
pc_sum_wday$time <- as.numeric(pc_sum_wday$hour)
pc_sum_weday$time <- as.numeric(pc_sum_weday$hour)

#Plotting total energy consumption per hour for weedkdays in Aug 2019
pc_sum_wday$time <- as.factor(pc_sum_wday$time)
pc_sum_wday[pc_sum_wday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Total power consumption of MG on a weekday in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting total energy consumption per hour for a weekend day in Aug 2019
pc_sum_weday$time <- as.factor(pc_sum_weday$time)
pc_sum_weday[pc_sum_weday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Total power consumption of MG on a weekend day in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting total energy consumption per hour for weedkdays in Sep 2019
pc_sum_wday[pc_sum_wday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Total power consumption of MG on a weekday in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting total energy consumption per hour for a weekend day in Sep 2019
pc_sum_weday[pc_sum_weday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Total power consumption of MG on a weekend day in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting total energy consumption per hour for weedkdays in Oct 2019
pc_sum_wday[pc_sum_wday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Total power consumption of MG on a weekday in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting total energy consumption per hour for a weekend day in Aug 2019
pc_sum_weday[pc_sum_weday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Total power consumption of MG on a weekend day in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

```

2. Hourly socket consumption at the hall for a weekend/week day in (month).

```{r, echo=FALSE}
#Hourly socket consumption at for a weekend/week day in (month)
#s1, s2, s3, s4 
pc_s <- data.frame()
pc_s <- rbind(pc_s, s1[s1$variable=="vRELAY1_LVL",],
                   s2[s2$variable=="vRELAY1_LVL",],
                   s3[s3$variable=="vRELAY1_LVL",],
                   s4[s4$variable=="vRELAY1_LVL",])

#Adding energy consumption per hour per day
pc_sum <- pc_s %>%
  group_by(date, hour) %>%
  summarise(value=sum(value))

#Add days of week to separate weekends from weekdays
pc_sum$wday <- weekdays(as.Date(pc_sum$date), abbreviate = TRUE)
pc_sum$month <- as.character(month(pc_sum$date, label=TRUE, abbr=TRUE))
pc_sum_wday <- pc_sum[pc_sum$wday=="Mon" | pc_sum$wday=="Tue" | pc_sum$wday=="Wed" | 
                        pc_sum$wday=="Thu" | pc_sum$wday=="Fri", ]
pc_sum_weday <- pc_sum[pc_sum$wday=="Sat" | pc_sum$wday=="Sun" , ]
pc_sum_wday$time <- as.numeric(pc_sum_wday$hour)
pc_sum_weday$time <- as.numeric(pc_sum_weday$hour)

#Plotting sockets energy consumption per hour for a weekday in Aug 2019
pc_sum_wday$time <- as.factor(pc_sum_wday$time)
pc_sum_wday[pc_sum_wday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of sockets on a weekday in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting sockets energy consumption per hour for a weekend day in Aug 2019
pc_sum_weday$time <- as.factor(pc_sum_weday$time)
pc_sum_weday[pc_sum_weday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of sockets on a weekend day in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting sockets energy consumption per hour for a weekday in Sep 2019
pc_sum_wday[pc_sum_wday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of sockets on a weekday in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting sockets energy consumption per hour for a weekend day in Sep 2019
pc_sum_weday[pc_sum_weday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of sockets on a weekend day in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting sockets energy consumption per hour for a weekday in Oct 2019
pc_sum_wday[pc_sum_wday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of sockets on a weekday in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting sockets energy consumption per hour for a weekend day in Oct 2019
pc_sum_weday[pc_sum_weday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of sockets on a weekend day in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")
```

3. Hourly indoor light consumption at the hall for a weekend/week day in (month).

```{r, echo=FALSE}
#Hourly indoor light consumption at Hall for a weekend/week day in (month)
#cpe1-cpe4; cpe6-cpe7
pc_indoor_cpe <- data.frame()
pc_indoor_cpe <- rbind(pc_indoor_cpe, cpe1, cpe2, cpe3, cpe4, cpe6, cpe7)

#Adding energy consumption per hour per day
pc_sum <- pc_indoor_cpe %>%
  group_by(date, hour) %>%
  summarise(value=sum(value))

#Add days of week to separate weekends from weekdays
pc_sum$wday <- weekdays(as.Date(pc_sum$date), abbreviate = TRUE)
pc_sum$month <- as.character(month(pc_sum$date, label=TRUE, abbr=TRUE))
pc_sum_wday <- pc_sum[pc_sum$wday=="Mon" | pc_sum$wday=="Tue" | pc_sum$wday=="Wed" | 
                        pc_sum$wday=="Thu" | pc_sum$wday=="Fri", ]
pc_sum_weday <- pc_sum[pc_sum$wday=="Sat" | pc_sum$wday=="Sun" , ]
pc_sum_wday$time <- as.numeric(pc_sum_wday$hour)
pc_sum_weday$time <- as.numeric(pc_sum_weday$hour)

#Plotting indoor lights energy consumption per hour for a weekday in Aug 2019
pc_sum_wday$time <- as.factor(pc_sum_wday$time)
pc_sum_wday[pc_sum_wday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of indoor lights on a weekday in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting indoor lights energy consumption per hour for a weekend day in Aug 2019
pc_sum_weday$time <- as.factor(pc_sum_weday$time)
pc_sum_weday[pc_sum_weday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of indoor lights on a weekend day in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting indoor lights energy consumption per hour for a weekday in Sep 2019
pc_sum_wday[pc_sum_wday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of indoor lights on a weekday in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting indoor lights energy consumption per hour for a weekend day in Sep 2019
pc_sum_weday[pc_sum_weday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of indoor lights on a weekend day in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting indoor lights energy consumption per hour for a weekday in Oct 2019
pc_sum_wday[pc_sum_wday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of indoor lights on a weekday in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting indoor lights energy consumption per hour for a weekend day in Oct 2019
pc_sum_weday[pc_sum_weday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of indoor lights on a weekend day in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")
```

4. Hourly outdoor light consumption at the hall for a weekend/week day in (month).

```{r, echo=FALSE}
#Hourly outdoor light consumption at Hall for a weekend/week day in (month)
#cpe5
pc_outdoor_cpe <- data.frame()
pc_outdoor_cpe <- rbind(pc_outdoor_cpe, cpe5)

#Adding energy consumption per hour per day
pc_sum <- pc_outdoor_cpe %>%
  group_by(date, hour) %>%
  summarise(value=sum(value))

#Add days of week to separate weekends from weekdays
pc_sum$wday <- weekdays(as.Date(pc_sum$date), abbreviate = TRUE)
pc_sum$month <- as.character(month(pc_sum$date, label=TRUE, abbr=TRUE))
pc_sum_wday <- pc_sum[pc_sum$wday=="Mon" | pc_sum$wday=="Tue" | pc_sum$wday=="Wed" | 
                        pc_sum$wday=="Thu" | pc_sum$wday=="Fri", ]
pc_sum_weday <- pc_sum[pc_sum$wday=="Sat" | pc_sum$wday=="Sun" , ]
pc_sum_wday$time <- as.numeric(pc_sum_wday$hour)
pc_sum_weday$time <- as.numeric(pc_sum_weday$hour)

#Plotting outdoor lights energy consumption per hour for a weekday in Aug 2019
pc_sum_wday$time <- as.factor(pc_sum_wday$time)
pc_sum_wday[pc_sum_wday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of outdoor lights on a weekday in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting outdoor lights energy consumption per hour for a weekend day in Aug 2019
pc_sum_weday$time <- as.factor(pc_sum_weday$time)
pc_sum_weday[pc_sum_weday$month=="Aug",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of outdoor lights on a weekend day in Aug 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting outdoor lights energy consumption per hour for a weekday in Sep 2019
pc_sum_wday[pc_sum_wday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of outdoor lights on a weekday in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting outdoor lights energy consumption per hour for a weekend day in Sep 2019
pc_sum_weday[pc_sum_weday$month=="Sep",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of outdoor lights on a weekend day in Sep 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting outdoor lights energy consumption per hour for a weekday in Oct 2019
pc_sum_wday[pc_sum_wday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of outdoor lights on a weekday in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")

#Plotting outdoor lights energy consumption per hour for a weekend day in Oct 2019
pc_sum_weday[pc_sum_weday$month=="Oct",] %>%
  ggplot(aes(x=time, y=value)) +
  geom_boxplot(aes(color=time))  +
  labs(title="Power consumption of outdoor lights on a weekend day in Oct 2019" , 
       y="Power consumption (W)",
       x = "Hour of day")
```

Next, we move onto RQ2 - Does energy availability through a PV system increase energy demand over time?

1. Daily consumption of sockets for each month and daily consumption since commissioning.

```{r, echo=FALSE}
#1. Daily total energy consumption by the hall 
#Light consumption daily - sum of mean energy consumed per hour for all 24 hours
cpe_consumption <- cpe_all #This is hourly means
cpe_daily <- cpe_consumption %>%
  group_by(date, id) %>%
  summarise(value=sum(value))
#Total cpe consumption per day for all cpe
cpe_total <- cpe_daily %>%
  group_by(date) %>%
  summarise(value=sum(value))
cpe_total$id <- rep("CPE", length(cpe_total$date))

#Socket energy consumption - for each day get max value
s_consumption <- s_all[s_all$variable=="AC_Day_Energy_session", ]
s_consumption$value <- s_consumption$value * 0.017 #Converting Wm to Wh
#Daily consumption - get daily consumption for each socket
s_hours <- s_consumption %>%
  group_by(date,id) %>%
  summarise(value = value[length(value)])
#Sum consumption per day for all sockets
s_total <- s_hours %>%
  group_by(date) %>%
  summarise(value = sum(value))
s_total$id <- rep("S", length(s_total$date))

#Total energy consumed per day by both lights and sockets
cpe_s_daily <- data.frame() 
cpe_s_daily <- rbind(cpe_s_daily, cpe_total, s_total)
cpe_s_daily <- cpe_s_daily[order(cpe_s_daily$date), ]

energy_total <- cpe_s_daily %>%
  group_by(date) %>%
  summarise(value=sum(value))

energy_total$month <- month(energy_total$date, label = TRUE, abbr=TRUE)
startDate <- as.Date("2019-07-01")
energy_total$days <- as.numeric(energy_total$date - startDate)

#Total daily consumption in Aug 2019
energy_total$date <- as.factor(energy_total$date)
energy_total[energy_total$month=="Aug",] %>%
  ggplot(aes(x = date, y= value)) +
  geom_bar(stat="identity", width=.5,fill="orange") + 
  labs(title="Daily consumption in Aug 2019" , 
       y="Daily energy consumption (Wh)",
       x = "Day of month") +
  theme(axis.text.x = element_text(size=6, angle=45))

#Total daily consumption in Sep 2019
energy_total[energy_total$month=="Sep",] %>%
  ggplot(aes(x = date, y= value)) +
  geom_bar(stat="identity", width=.5,fill="orange") + 
  labs(title="Daily consumption in Sep 2019" , 
       y="Daily energy consumption (Wh)",
       x = "Day of month") +
  theme(axis.text.x = element_text(size=6, angle=45))

#Total daily consumption in Oct 2019
energy_total[energy_total$month=="Oct",] %>%
  ggplot(aes(x = date, y= value)) +
  geom_bar(stat="identity", width=.5,fill="orange") + 
  labs(title="Daily consumption in Oct 2019" , 
       y="Daily energy consumption (Wh)",
       x = "Day of month") +
  theme(axis.text.x = element_text(size=6, angle=45))

#Total energy consumption since commissioning
energy_total %>%
  ggplot(aes(x=days, y=value, color="Actual")) +
  geom_point(shape=8) + 
  labs(title="Total energy consumption since commissioning " , 
       y="Total consumption (Wh)",
       x = "Days since commissioning") +
  geom_hline(aes(yintercept=1000, color="Predicted"))

#Getting daily average per month
energy_month <- energy_total %>%
  group_by(month) %>%
  summarise(value=mean(value))
energy_month$id <- rep("Actual", length(energy_month$month))

energy_month_pred <- energy_month
energy_month_pred$value <- 1000.0
energy_month_pred$id <- rep("Predicted", length(energy_month_pred$month))

energy_month <- rbind(energy_month, energy_month_pred)
energy_month$id <- as.factor(energy_month$id)
energy_month %>%
  ggplot(aes(x=month, y=value, fill=id)) +
  geom_bar(stat="identity", width=.5, position="dodge") + 
  labs(title="Average total daily energy consumption" , 
       y="Average daily energy consumption (Wh)",
       x = "Month") 
```


2. Daily total user consumption loads for the hall in (month). 

```{r, echo=FALSE}
#2. Daily total user and system consumption loads for the hall in (month).
# aux, outdoor lights, indoor lights, s1, s2, s3, s4
#Daily indoor lights
cpe_daily_in <- cpe_daily[cpe_daily$id!="CPE5", ]
cpe_daily_indoor <- cpe_daily_in %>%
  group_by(date) %>%
  summarise(value=sum(value))
cpe_daily_indoor$location <- rep("Indoor lights", length(cpe_daily_indoor$date))
cpe_daily_outdoor <- cpe_daily[cpe_daily$id=="CPE5", ]
cpe_daily_outdoor$location <- rep("Outoor lights", length(cpe_daily_outdoor$date))
cpe_daily_outdoor <- cpe_daily_outdoor[,-2]
s_daily <- s_hours
s_daily$location <- s_daily$id
s_daily <- s_daily[,-2]

#Calculating AC auxiliary loads, and excluding system losses, is given by the 
#[AC Consumption L1 - all socket and CPE consumption values].
ac_consumption <- systemData[,c(1,2)]
colnames(ac_consumption) <- c("timestamp", "AC_consumption_L1_W")
#Calculate hourly mean
ac_consumption$timestamp <- strptime(ac_consumption$timestamp, "%Y-%m-%d %H:%M:%S")
ac_consumption$date <- as.Date(format(ac_consumption$timestamp, format='%Y-%m-%d'))
ac_consumption$time <- format(ac_consumption$timestamp, format='%H')
ac_consumption <- ac_consumption[ac_consumption$date>"2019-07-31" & 
                                   ac_consumption$date<"2019-11-01", ]
ac_consumption <- na.omit(ac_consumption)
#Extract hourly means 
ac_hours <- ac_consumption %>%
  group_by(date, time) %>%
  summarise(value = mean(AC_consumption_L1_W))
#Daily ac consumption - sum of values for all 24 hours 
ac_days <- ac_hours %>%
  group_by(date) %>%
  summarise(value=sum(value))
colnames(ac_days) <- c("Date", "AC_consumption")

#Calculating auxiliary load as ac consumption - sc - cpe
#Use spread to separate keys into columns 
library(tidyr)
cpe_indoor_spread <- spread(cpe_daily_indoor, location, value)
cpe_outdoor_spread <- spread(cpe_daily_outdoor, location, value)
sc_spread <- spread(s_daily, location, value)
sc_spread[is.na(sc_spread)] <- 0

#Merge all the datasets
ac_days <- cbind(ac_days, cpe_indoor_spread[,-1], cpe_outdoor_spread[,-1], 
                 sc_spread[,-1])
ac_days$Aux <- ac_days$AC_consumption - ac_days$`Indoor lights` - 
  ac_days$`Outoor lights` - ac_days$S1 - ac_days$S2 - ac_days$S3 - ac_days$S4
daily_profile <- ac_days[,-2]
daily_profile$Date <- as.factor(daily_profile$Date)
daily_profile_gather <- gather(daily_profile, "key", "value", 2:8)
daily_profile_gather$month <- as.character(month(daily_profile_gather$Date, 
                                                 label=TRUE, abbr=TRUE))

#Daily user and system consumption in Aug 2019
daily_profile_gather[daily_profile_gather$month=="Aug", ] %>%
  ggplot(aes(x = Date, y= value, fill = key)) +
  geom_bar(stat="identity", width=.5, position = "stack") + 
  labs(title="Daily user and system energy consumption in Aug 2019" , 
       y="Daily consumption (Wh)",
       x = "Day of month") +
  theme(axis.text.x = element_text(size=6, angle=45))

#Daily user and system consumption in Sep 2019
daily_profile_gather[daily_profile_gather$month=="Sep", ] %>%
  ggplot(aes(x = Date, y= value, fill = key)) +
  geom_bar(stat="identity", width=.5, position = "stack") + 
  labs(title="Daily user and system energy consumption in Sep 2019" , 
       y="Daily consumption (Wh)",
       x = "Day of month") +
  theme(axis.text.x = element_text(size=6, angle=45))

#Daily user and system consumption in Oct 2019
daily_profile_gather[daily_profile_gather$month=="Oct", ] %>%
  ggplot(aes(x = Date, y= value, fill = key)) +
  geom_bar(stat="identity", width=.5, position = "stack") + 
  labs(title="Daily user and system energy consumption in Oct 2019" , 
       y="Daily consumption (Wh)",
       x = "Day of month") +
  theme(axis.text.x = element_text(size=6, angle=45))
```


3. Monthly energy consumption profile for the hall users.  

```{r, echo=FALSE}
#3. Monthly energy consumption profile for the micro-grid users.
library(lubridate)
monthly_profile <- daily_profile_gather %>%
  group_by(month, key) %>%
  summarise(value=sum(value))

monthly_profile$month <- as.factor(monthly_profile$month)  
monthly_profile %>%
  ggplot(aes(x = month, y= value/1000, fill = key)) +
  geom_bar(stat="identity", width=.5, position = "stack") + 
  labs(title="Total monthly energy consumption values at Nyabiheke hall" , 
       y="Total monthly energy consumption (kWh)",
       x = "Month of study") 
```


RQ3 -  How valid and accurate were our assumptions and simulations to design and
size the system using predicted energy demand profiles and meteorological
conditions?

1. Distribution of energy-use over and under predictions at the hall
```{r, echo=FALSE}

```

2. Actual and predicted typical day power profile at the hall in (month)
```{r, echo=FALSE}
########################################## RQ 3 ############################
#Typical day profiles are obtained from determining hourly mean (e.g. 1
#a.m. to 2 a.m.) values for every day and taking the average
#Act. PV Power Output: [PV Power]
pv_power <- systemData[,c(1,3)]
colnames(pv_power) <- c("timestamp", "PV power_W")
#Calculate hourly mean
pv_power$timestamp <- strptime(pv_power$timestamp, "%Y-%m-%d %H:%M:%S")
pv_power$date <- as.Date(format(pv_power$timestamp, format='%Y-%m-%d'))
pv_power$time <- format(pv_power$timestamp, format='%H')
pv_power <- pv_power[pv_power$date>"2019-07-31" & 
                       pv_power$date<"2019-11-01", ]
pv_power <- na.omit(pv_power)
#Extract hourly means 
pv_power_hours <- pv_power %>%
  group_by(date, time) %>%
  summarise(value = mean(`PV power_W`))
pv_power_hours$month <- as.character(month(pv_power_hours$date, label=TRUE, abbr=TRUE))
#Getting profile for a typical day for each month - get avg of values per hour
pv_power_day <- pv_power_hours %>%
  group_by(month, time) %>%
  summarise(value=mean(value))
colnames(pv_power_day) <- c("Month", "Time", "Actual PV Power")

# AC load, E: [AC consumption L1]
#Add month to hourly means for AC load calculated for RQ2
ac_hours$month <- as.character(month(ac_hours$date, label=TRUE, abbr=TRUE))
#Getting profile for a typical day for each month - get avg of values per hour
ac_load_day <- ac_hours %>%
  group_by(month, time) %>%
  summarise(value=mean(value))
ac_load_day$id <- rep("AC Load", length(ac_load_day$month))
colnames(ac_load_day) <- c("Month", "Time", "AC Load")

# Battery Charge Power: The [Charged Energy] column gives this value in kWh.
#You can convert to kW and then take a mean for the hour.
battery_charge <- systemData[,c(1,6)]
colnames(battery_charge) <- c("timestamp", "Charged_energy")
#Calculate hourly mean
battery_charge$timestamp <- strptime(battery_charge$timestamp, "%Y-%m-%d %H:%M:%S")
battery_charge$date <- as.Date(format(battery_charge$timestamp, format='%Y-%m-%d'))
battery_charge$time <- format(battery_charge$timestamp, format='%H')
battery_charge <- battery_charge[battery_charge$date>"2019-07-31" & 
                                   battery_charge$date<"2019-11-01", ]
#The battery charge values are missing in the morning and evening
#Some values in between are also missing in the middle.
#We remove the NA values
battery_charge <- na.omit(battery_charge)
#Extract hourly values by taking the max value each hour 
battery_charge_hours <- battery_charge %>%
  group_by(date, time) %>%
  summarise(value = Charged_energy[length(Charged_energy)])
#Converting kWh to kW per hour
#battery_charge_hours$value <- battery_charge_hours$value / 60.0
a <- diff(battery_charge_hours$value)
battery_charge_hours <- battery_charge_hours[-1,]
battery_charge_hours$value <- a
battery_charge_hours$month <- as.character(month(battery_charge_hours$date, label=TRUE, abbr=TRUE))

#Getting profile for a typical day for each month - get avg of values per hour
battery_charge_day <- battery_charge_hours %>%
  group_by(month, time) %>%
  summarise(value=mean(value))
battery_charge_day$value <- battery_charge_day$value * 1000 #Converting to W

#Converting in a data frame to combine later
battery_charge_day$key <- rep("Charged Energy", length(battery_charge_day$month))
colnames(battery_charge_day) <- c("Month", "Time", "value", "key")
battery_charge_day <- data.frame("Month"=battery_charge_day$Month, 
                                 "Time"=battery_charge_day$Time,
                                 "key"=battery_charge_day$key,
                                 "value"=battery_charge_day$value, 
                                 stringsAsFactors = FALSE)

# Battery Discharge Power: The [Discharge Energy] column gives this value in
#kWh. You can convert to kW and then take a mean for the hour.
battery_discharge <- systemData[,c(1,5)]
colnames(battery_discharge) <- c("timestamp", "Discharged_energy")
#Calculate hourly mean
battery_discharge$timestamp <- strptime(battery_discharge$timestamp, "%Y-%m-%d %H:%M:%S")
battery_discharge$date <- as.Date(format(battery_discharge$timestamp, format='%Y-%m-%d'))
battery_discharge$time <- format(battery_discharge$timestamp, format='%H')
battery_discharge <- battery_discharge[battery_discharge$date>"2019-07-31" & 
                                         battery_discharge$date<"2019-11-01", ]
#The battery discharge values are missing in the morning and evening
#Some values in between are also missing in the middle.
#We remove the NA values
battery_discharge <- na.omit(battery_discharge)
#Extract hourly values by taking the max value each hour 
battery_discharge_hours <- battery_discharge %>%
  group_by(date, time) %>%
  summarise(value = Discharged_energy[length(Discharged_energy)])
#Converting kWh to kW per hour
#battery_charge_hours$value <- battery_charge_hours$value / 60.0
a <- diff(battery_discharge_hours$value)
battery_discharge_hours <- battery_discharge_hours[-1,]
battery_discharge_hours$value <- a
battery_discharge_hours$month <- as.character(month(battery_discharge_hours$date, label=TRUE, abbr=TRUE))

#Getting profile for a typical day for each month - get avg of values per hour
battery_discharge_day <- battery_discharge_hours %>%
  group_by(month, time) %>%
  summarise(value=mean(value))
battery_discharge_day$value <- battery_discharge_day$value * 1000 #W

#Converting in a data frame to combine later
battery_discharge_day$key <- rep("Discharged Energy", length(battery_discharge_day$month))
colnames(battery_discharge_day) <- c("Month", "Time", "value", "key")
battery_discharge_day <- data.frame("Month"=battery_discharge_day$Month, 
                                    "Time"=battery_discharge_day$Time,
                                    "key"=battery_discharge_day$key,
                                    "value"=battery_discharge_day$value, 
                                    stringsAsFactors = FALSE)

# Battery state of charge is stated directly - stated in %
state_charge <- systemData[,c(1,4)]
colnames(state_charge) <- c("timestamp", "State_of_charge")
#Calculate hourly mean
state_charge$timestamp <- strptime(state_charge$timestamp, "%Y-%m-%d %H:%M:%S")
state_charge$date <- as.Date(format(state_charge$timestamp, format='%Y-%m-%d'))
state_charge$time <- format(state_charge$timestamp, format='%H')
state_charge <- state_charge[state_charge$date>"2019-07-31" & 
                               state_charge$date<"2019-11-01", ]
state_charge <- na.omit(state_charge)
#Extract hourly means 
state_charge_hours <- state_charge %>%
  group_by(date, time) %>%
  summarise(value = mean(`State_of_charge`))
state_charge_hours$month <- as.character(month(state_charge_hours$date, label=TRUE, abbr=TRUE))
#Getting profile for a typical day for each month - get avg of values per hour
state_charge_day <- state_charge_hours %>%
  group_by(month, time) %>%
  summarise(value=mean(value))
state_charge_day$id <- rep("State of charge", length(state_charge_day$month))
state_charge_day <- spread(state_charge_day, id, value)
colnames(state_charge_day) <- c("Month", "Time", "State of charge")

#Hourly Pot. PV power output values will be provided separately from live data
#obtained from SolCast in kW/m2. This value needs to be multiplied by the area
#of the array (13.094 m2) and panel efficiency (15.6%).
pot_pv_output <- weather_data[,c(1,2)]
colnames(pot_pv_output) <- c("timestamp", "PV_incident_solar")
pot_pv_output$PV_incident_solar <- pot_pv_output$PV_incident_solar * 13.094 * 0.156
pot_pv_output$PV_incident_solar <- pot_pv_output$PV_incident_solar * 1000 #W
#Calculate hourly mean
pot_pv_output$timestamp <- strptime(pot_pv_output$timestamp, "%Y-%m-%d %H:%M:%S")
pot_pv_output$date <- as.Date(format(pot_pv_output$timestamp, format='%Y-%m-%d'))
pot_pv_output$time <- format(pot_pv_output$timestamp, format='%H')
pot_pv_output <- pot_pv_output[pot_pv_output$date>"2019-07-31" & 
                                 pot_pv_output$date<"2019-11-01", ]
pot_pv_output <- na.omit(pot_pv_output)
#Extract hourly means 
pot_pv_output_hours <- pot_pv_output %>%
  group_by(date, time) %>%
  summarise(value = mean(PV_incident_solar))
pot_pv_output_hours$month <- as.character(month(pot_pv_output_hours$date, label=TRUE, abbr=TRUE))
#Getting profile for a typical day for each month - get avg of values per hour
pot_pv_output_day <- pot_pv_output_hours %>%
  group_by(month, time) %>%
  summarise(value=mean(value))

# Capture losses, Lc = Pot. PV power output – Act. PV power output
#Actual PV power is pv_power_day
#Predicted PV power is pot_pv_output_day
pot_pv_output_day$losses <- pot_pv_output_day$value - pv_power_day$`Actual PV Power`
colnames(pot_pv_output_day) <- c("Month", "Time", "Pot. PV Power", "Capture losses")

#Bringing all the data together
data <- as.data.frame(pot_pv_output_day)
data <- cbind(data, as.data.frame(pv_power_day[,3]), 
              as.data.frame(ac_load_day[,3]), as.data.frame(state_charge_day[,3]))
data_day <- gather(data, "key", "value", 3:7)
data_day <- rbind(data_day, battery_charge_day, battery_discharge_day)
data_spread <- spread(data_day, key, value)
data_spread[is.na(data_spread)] = 0
data_spread$Time <- as.numeric(data_spread$Time)

#Plotting all variables for Aug 2019
data_spread[data_spread$Month=="Aug", ] %>%
  ggplot(aes(x=Time)) +
  geom_line(aes(y = `AC Load`/1000.0, color = "AC Load"), linetype=1) + 
  geom_point(aes(y = `AC Load`/1000.0, color = "AC Load"), shape=1) + 
  geom_line(aes(y = `Actual PV Power`/1000.0, color = "Actual PV Power"), linetype=2) + 
  geom_point(aes(y = `Actual PV Power`/1000.0, color = "Actual PV Power"), shape=2) + 
  geom_line(aes(y = `Capture losses`/1000.0, color = "Capture losses"), linetype=3) + 
  geom_point(aes(y = `Capture losses`/1000.0, color = "Capture losses"), shape=3) + 
  geom_line(aes(y = `Charged Energy`/1000.0, color = "Charged Energy"), linetype=4) + 
  geom_point(aes(y = `Charged Energy`/1000.0, color = "Charged Energy"), shape=4) + 
  geom_line(aes(y = `Discharged Energy`/1000.0, color = "Discharged Energy"), linetype=5) + 
  geom_point(aes(y = `Discharged Energy`/1000.0, color = "Discharged Energy"), shape=5) + 
  geom_line(aes(y = `Pot. PV Power`/1000.0, color = "Pot. PV Power"), linetype=6) + 
  geom_point(aes(y = `Pot. PV Power`/1000.0, color = "Pot. PV Power"), shape=6) + 
  geom_line(aes(y = `State of charge`/100.0, color = "State of charge"), linetype=7) + 
  geom_point(aes(y = `State of charge`/100.0, color = "State of charge"), shape=7) +
  scale_y_continuous(sec.axis = sec_axis(~.*100, name = "State of charge (%)")) +
  labs(title="Actual Hall power profile for a typical day in Aug 2019" , 
       y="Power (kW)",
       x = "Time of day", 
       colour="Paramter")

#Plotting a typical day in Sep 2019
data_spread[data_spread$Month=="Sep", ] %>%
  ggplot(aes(x=Time)) +
  geom_line(aes(y = `AC Load`/1000.0, color = "AC Load"), linetype=1) + 
  geom_point(aes(y = `AC Load`/1000.0, color = "AC Load"), shape=1) + 
  geom_line(aes(y = `Actual PV Power`/1000.0, color = "Actual PV Power"), linetype=2) + 
  geom_point(aes(y = `Actual PV Power`/1000.0, color = "Actual PV Power"), shape=2) + 
  geom_line(aes(y = `Capture losses`/1000.0, color = "Capture losses"), linetype=3) + 
  geom_point(aes(y = `Capture losses`/1000.0, color = "Capture losses"), shape=3) + 
  geom_line(aes(y = `Charged Energy`/1000.0, color = "Charged Energy"), linetype=4) + 
  geom_point(aes(y = `Charged Energy`/1000.0, color = "Charged Energy"), shape=4) + 
  geom_line(aes(y = `Discharged Energy`/1000.0, color = "Discharged Energy"), linetype=5) + 
  geom_point(aes(y = `Discharged Energy`/1000.0, color = "Discharged Energy"), shape=5) + 
  geom_line(aes(y = `Pot. PV Power`/1000.0, color = "Pot. PV Power"), linetype=6) + 
  geom_point(aes(y = `Pot. PV Power`/1000.0, color = "Pot. PV Power"), shape=6) + 
  geom_line(aes(y = `State of charge`/100.0, color = "State of charge"), linetype=7) + 
  geom_point(aes(y = `State of charge`/100.0, color = "State of charge"), shape=7) +
  scale_y_continuous(sec.axis = sec_axis(~.*100, name = "State of charge (%)")) +
  labs(title="Actual Hall power profile for a typical day in Sep 2019" , 
       y="Power (kW)",
       x = "Time of day", 
       colour="Paramter")

#Plotting a typical day in Oct 2019
data_spread[data_spread$Month=="Oct", ] %>%
  ggplot(aes(x=Time)) +
  geom_line(aes(y = `AC Load`/1000.0, color = "AC Load"), linetype=1) + 
  geom_point(aes(y = `AC Load`/1000.0, color = "AC Load"), shape=1) + 
  geom_line(aes(y = `Actual PV Power`/1000.0, color = "Actual PV Power"), linetype=2) + 
  geom_point(aes(y = `Actual PV Power`/1000.0, color = "Actual PV Power"), shape=2) + 
  geom_line(aes(y = `Capture losses`/1000.0, color = "Capture losses"), linetype=3) + 
  geom_point(aes(y = `Capture losses`/1000.0, color = "Capture losses"), shape=3) + 
  geom_line(aes(y = `Charged Energy`/1000.0, color = "Charged Energy"), linetype=4) + 
  geom_point(aes(y = `Charged Energy`/1000.0, color = "Charged Energy"), shape=4) + 
  geom_line(aes(y = `Discharged Energy`/1000.0, color = "Discharged Energy"), linetype=5) + 
  geom_point(aes(y = `Discharged Energy`/1000.0, color = "Discharged Energy"), shape=5) + 
  geom_line(aes(y = `Pot. PV Power`/1000.0, color = "Pot. PV Power"), linetype=6) + 
  geom_point(aes(y = `Pot. PV Power`/1000.0, color = "Pot. PV Power"), shape=6) + 
  geom_line(aes(y = `State of charge`/100.0, color = "State of charge"), linetype=7) + 
  geom_point(aes(y = `State of charge`/100.0, color = "State of charge"), shape=7) +
  scale_y_continuous(sec.axis = sec_axis(~.*100, name = "State of charge (%)")) +
  labs(title="Actual Hall power profile for a typical day in Oct 2019" , 
       y="Power (kW)",
       x = "Time of day", 
       colour="Paramter")

```

3. Box plot of actual and predicted monthly capture loss values 
```{r, echo=FALSE}
#3. Box plot of actual and predicted monthly capture loss values 
#Capture loss is Lc = Pot. PV power output – Act. PV power output
loss_hours <- pot_pv_output_hours
loss_hours$value <- (loss_hours$value - pv_power_hours$value) / 1000.0 #kW
loss_days <- loss_hours %>%
  group_by(month, date) %>%
  summarise(value = mean(value))
#Converting to kWh by multiplying each value by 24 hours to get daily kWh
loss_days$value <- loss_days$value * 24 #kW*h = kWh
loss_days$month <- as.factor(loss_days$month)
loss_days %>%
  ggplot(aes(x=month, y=value)) + 
  geom_errorbar(aes(ymin=min(value),ymax=max(value)),linetype = 1,width = 0.5) +
  geom_boxplot()  +
  labs(title="Excess Electrical Production Monthly Averages in 2019" , 
       y="Total daily capture loss (kWh) ",
       x = "Month")
```

To investigate further the potential PV power that is not utilised at the hall, we show the estimated monthly capture losses in comparison to the utilised PV power. The ratio of utilised PV power to potential PV power is known as
the performance ratio, and we will want to see how this changes with energy demands at the hall. The production factor is particularly important for standalone PV-battery systems, where surplus energy from PV panels cannot be exported to a grid network. The production factor is the ratio of actual PV yield to potential PV power. The system’s overall efficiency is the ratio of the consumed AC load to the in-plane irradiance on the PV array.

```{r, echo=FALSE}
#Figure 8 - Utilised PV Yield, Capture losses, System losses per month
#Utilised PV Yield (E) = AC load (kWh) for the given analysis period
#System losses (Ls) = actual PV output (kWh) for the same period - Utilised PV yield

#Calculating utilised PV Yield 
pv_yield <- ac_hours #Hourly means in W
#Calculate per day values by adding all values - Wh
pv_yield_daily <- pv_yield %>%
  group_by(month, date) %>%
  summarise(value=sum(value))
pv_yield_daily$value <- pv_yield_daily$value / 1000.0 #Converting to kWh
#Calculate pv_yield for the whole month - either take avg and multiple by days or sum
pv_yield_month <- pv_yield_daily %>%
  group_by(month) %>%
  summarise(value=sum(value))
colnames(pv_yield_month) <- c("month", "PV yield")

#Calculating actual PV output for the same period
pv_output <- pv_power_hours #Hourly means in W
#Calculate per day values by adding all values - Wh
pv_output_daily <- pv_output %>%
  group_by(month, date) %>%
  summarise(value=sum(value))
pv_output_daily$value <- pv_output_daily$value / 1000.0 #Converting to kWh
#Calculate pv_output for the whole month - either take avg and multiple by days or sum
pv_output_month <- pv_output_daily %>%
  group_by(month) %>%
  summarise(value=sum(value))
colnames(pv_output_month) <- c("month", "PV output")

#System losses
sysLoss <- pv_output_month
sysLoss$`PV output` <- sysLoss$`PV output` - pv_yield_month$`PV yield`
colnames(sysLoss) <- c("month", "System loss")

#Calculating capture losses for the same period
capLoss <- loss_hours #in kW
#Calculating per day values by adding all values - kWh
capLoss_daily <- capLoss %>%
  group_by(month, date) %>%
  summarise(value=sum(value))
#Calculate capture loss for the whole month - either take avg and multiple by days or sum
capLoss_month <- capLoss_daily %>%
  group_by(month) %>%
  summarise(value=sum(value))
colnames(capLoss_month) <- c("month", "capture loss")

#Plotting for each month
data_yield <- pv_yield_month
data_yield <- cbind(data_yield, capLoss_month[,2], sysLoss[,2])
data_yield <- gather(data_yield, "key", "value", 2:4)
data_yield$month <- as.factor(data_yield$month)
data_yield %>%
  ggplot(aes(x = month, y= value, fill = key)) +
  geom_bar(stat="identity", width=.5, position = "stack") + 
  labs(title="Total monthly electrical energy values at Nyabiheke hall in 2019" , 
       y="Consumed and potential electrical energy (kWh)",
       x = "Month") 

################ Figure 9 ###################################################

```